import { Injectable } from '@angular/core';
import * as Bn from "../../../node_modules/bn.js/lib/bn.js";

@Injectable()

export class BabyjubjubService {

  a = new Bn('168700', 10);
  d = new Bn('168696', 10);
  g = [new Bn('17777552123799933955779906779655732241715742912184938656739573121738514868268', 10),
  new Bn('2626589144620713026669568689430873010625803728049924121243784502389097019475', 10)];

  q = new Bn('21888242871839275222246405745257275088548364400416034343698204186575808495617', 10);

  zero =[new Bn('0', 10),new Bn('1', 10)];

  referencePoints = [[new Bn('16540640123574156134436876038791482806971768689494387082833631921987005038935',10),new Bn('20819045374670962167435360035096875258406992893633759881276124905556507972311',10)],[new Bn('16113908992958654580576121332105641939386785007070631827837038721187369061406',10),new Bn('13543135889321786196419170914180430694274295243334629701622351182531864521005',10)],[new Bn('1076620697199135180779993208327990452191184083362380553163440209762849514722',10),new Bn('9853647717691139336869472377314617825232074251805086035693773616712748042621',10)],[new Bn('16627001262217752418232399229085639463508031460877751193558076525766939746290',10),new Bn('11293652998871813128673002603563161847178345330386607075500167792306707414784',10)],[new Bn('17193433650870834145767552013187426225541809928144693031023390964075029712734',10),new Bn('5072569689932329450279131871579186295141413025474978915530995363951190322881',10)],[new Bn('4873235912926533530309568745817380743686540272116562512062487934223913563495',10),new Bn('20887932140417543826962958973692455850672178541440622622454994848671306619256',10)],[new Bn('13767260734734474739001976441109696104935454744751485173007370998306247492837',10),new Bn('7277100362785830115685758358246384145272350050315302288606808934579002798170',10)],[new Bn('5168666886441176511838430760090984216786231009368839315781763235428028670684',10),new Bn('3540433457622386931934945079292210609637634993709224481925029112076460456996',10)],[new Bn('17046338648613415398615213812309234521849044588294307506973008689438840217899',10),new Bn('14272669301071735679182285797323588275064578318544636168261104544792101541990',10)],[new Bn('6103107088791296435663387020164733811397570791509925308172821397187679660537',10),new Bn('20157929798032613907880757565781377612126801225727980602298341328786303458379',10)],[new Bn('565031082270784511526969856259883151926356254071667969886730963860599728056',10),new Bn('14351326155628442688947194939783765682844161210398113742490075739781323640871',10)],[new Bn('1878074526134353812641663603934698101461986157998056830302811006883988187476',10),new Bn('5565682932474786197900781172367838372598722114471922169620164749116211930418',10)],[new Bn('13672169211433958273621238439911098016168010235805679272891906788825906767477',10),new Bn('16993769844209052488906232590926697127416351186634421476666285502971626970799',10)],[new Bn('8786223216203880201224432554831626947213331095198567432758715078977508525796',10),new Bn('16797242172883548168306567617635110425492927504670010689612741788509959995399',10)],[new Bn('19511309402973225262220917535135014365437820143921553826584252488702725453571',10),new Bn('9338977329665951798955457617712647275145997611482141302608593432255344579057',10)],[new Bn('16028196540354630930568165251687951500491621991802323119452548785930915528076',10),new Bn('18645848113938245520223945248697200125633399343990508671600304297984017349160',10)],[new Bn('19742431422261785319802821264201579700941162512642502337867718752917066272640',10),new Bn('536084822077324023932884466004395638775832375297641821069560863946633279466',10)],[new Bn('14746857159778379625020692419257609100427724837329870240615509615917072852253',10),new Bn('7425274762180503574751542408424612279826320412501428803476842575167052357727',10)],[new Bn('20889720887632746108337230904734401090249084928639392128409710264031189168079',10),new Bn('7374404549650513296245607667385829743858871232666564805397932455623504294931',10)],[new Bn('11456585778581014417551378754926360274765118796288219726069431816759660290973',10),new Bn('3742731251980531555285474025831654734487023770305417749240256628868846389433',10)],[new Bn('1053825478491259598928875231158071559648900247213065117000464156362957297198',10),new Bn('7750617224000830369483777989476229656733788257200638169878226052413733766319',10)]]

  assertOnCurve (P):boolean {
    var uu = P[0].mul(P[0]);
    var vv = P[1].mul(P[1]);
    var left = (this.a.mul(uu).add(vv)).umod(this.q);
    var right = this.d.mul(uu).mul(vv).addn(1).umod(this.q);
    console.log(left.eq(right));
    return left.eq(right);
  }

  add (P1, P2){
    var u = P1[0], v = P1[1];
    var x = P2[0], y = P2[1];
    var allMul = this.d.mul(u).mul(v).mul(x).mul(y);
    var xtop = (u.mul(y).add(x.mul(v))).umod(this.q);

    var du = (xtop.mul((allMul.addn(1)).invm(this.q))).umod(this.q);

    var ytop = v.mul(y).sub(this.a.mul(u).mul(x));
    var dv = (ytop.mul((allMul.neg().addn(1)).invm(this.q))).umod(this.q);
    return [du, dv];
  }

  multiply (exp, P){
    var R0 = this.zero;
    var R1 = P;
    var exp_bin = exp.toString(2, 253);
    for (var i=252; i>=0; i--) {
      if (exp_bin.charAt(i) == '1'){
        R0 = this.add(R0, R1);
      }
      R1 = this.add(R1, R1);
    }
    return R0;
  }

  pedersenCommitment (inputs, secret) {
    var i;
    var pedRoot = this.zero;
    for (i = 0; i < inputs.length;i++){
      pedRoot = this.add(pedRoot,this.multiply(inputs[i],this.referencePoints[i]));
      console.log(pedRoot[0].toString(10));
      this.assertOnCurve(pedRoot);
    }

    pedRoot = this.add (pedRoot,
                  this.multiply(secret,this.referencePoints[this.referencePoints.length - 1]));
    console.log(pedRoot[0].toString(10));
    this.assertOnCurve(pedRoot);
    return pedRoot
  }

}
